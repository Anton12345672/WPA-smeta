

    function calcRow(id) {
        const row = document.getElementById(`row-${id}`);
        const cost = +row.querySelector('.i-cost').value || 0;
        const price = +row.querySelector('.i-price').value || 0;
        const div = document.getElementById(`an-${id}`);
        if(price > 0) {
            const markup = price - cost;
            const margin = ((markup / price) * 100).toFixed(1);
            div.innerHTML = <span class="markup">Наценка: ${markup}</span> | <span>Маржа: ${margin}%</span>;
        }
    }

    function saveEstimate() {
        const rows = document.querySelectorAll('.item-row');
        let items = [];
        let totalRev = 0;
        let totalCost = 0;

        rows.forEach(row => {
            const item = {
                name: row.querySelector('.i-name').value,
                unit: row.querySelector('.i-unit').value,
                qty: +row.querySelector('.i-qty').value,
                cost: +row.querySelector('.i-cost').value,
                price: +row.querySelector('.i-price').value
            };
            if(item.name) {
                items.push(item);
                totalRev += (item.price * item.qty);
                totalCost += (item.cost * item.qty);
            }
        });

        const estimate = {
            id: '#' + Math.floor(Math.random() * 10000),
            client: document.getElementById('client-name').value || 'Новый клиент',
            date: new Date().toLocaleDateString(),
            items: items,
            total: totalRev,
            profit: totalRev - totalCost,
            status: document.getElementById('status').value,
            currency: document.getElementById('currency').value
        };

        estimates.push(estimate);
        localStorage.setItem('smeta_ads_data', JSON.stringify(estimates));
        downloadPDF(estimate);
        closeEditor();
    }

    function renderDashboard() {
        const tbody = document.querySelector('#estimates-list tbody');
        tbody.innerHTML = '';
        let tRev = 0, tProf = 0;

        estimates.forEach((est, index) => {
            tRev += est.total;
            tProf += est.profit;
            tbody.innerHTML += `
                <tr>
                    <td>${est.id}</td>
                    <td><b>${est.client}</b></td>
                    <td>${est.date}</td>
                    <td>${est.total} ${est.currency}</td>
                    <td style="color:var(--success)">${est.profit} ${est.currency}</td>
                    <td><span class="status-badge status-${est.status}">${est.status}</span></td>
                    <td><button class="btn btn-outline" onclick="deleteEst(${index})">Удалить</button></td>
                </tr>
            `;
        });

        document.getElementById('dash-total').innerText = tRev + ' €';
        document.getElementById('dash-profit').innerText = tProf + ' €';
        document.getElementById('dash-count').innerText = estimates.length;
    }

    function deleteEst(index) {
        estimates.splice(index, 1);
        localStorage.setItem('smeta_ads_data', JSON.stringify(estimates));
        renderDashboard();
    }

    function downloadPDF(est) {
        const element = document.getElementById('pdf-template');
        document.getElementById('pdf-client-display').innerText = est.client;
        document.getElementById('pdf-id').innerText = est.id;
        document.getElementById('pdf-date').innerText = est.date;
        
        const tbody = document.querySelector('#pdf-table tbody');
        tbody.innerHTML = est.items.map(i => `
            <tr><td>${i.name} (${i.unit})</td><td>${i.qty}</td><td>${i.price} ${est.currency}</td><td>${i.qty * i.price} ${est.currency}</td></tr>
        `).join('');
        
        document.getElementById('pdf-totals').innerHTML = <h3>ИТОГО: ${est.total} ${est.currency}</h3>;

        html2pdf().set({ margin: 10, filename: Smeta_${est.client}.pdf, html2canvas: { scale: 2 } }).from(element).save();
    }

    renderDashboard();
</script>
</body>
</html>
